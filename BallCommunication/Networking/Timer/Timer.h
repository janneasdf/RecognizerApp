/*********************************************************************
    Timer?N???X			?uTimer.h?v

    ?T?v:
        SDL???g????1msec?P???^?C?}??ACPU??N???b?N?J?E???^???g???????????\?^?C?}?B

    Date:
        Created: 2009/01/16	By ?????r??
        Updated: 2010/07/10	By ?????r??	???????????????????
        Updated: 2013/03/07	By ?????r??	x64?p??RDTSC?^?C?}?[??????(?C?????C???A?Z???u???p?~)
 *********************************************************************/
#ifndef __Timer_H__
#define __Timer_H__

#pragma warning(disable: 4293)		// ?V?t?g????????????I??x??????

#include "../../Libraries/SDL/include/SDL.h"

#ifndef STRICT
  #define STRICT
#endif

#ifndef WIN32_LEAN_AND_MEAN
  #define WIN32_LEAN_AND_MEAN
#endif

#ifndef _WINDOWS_
  #include <windows.h>
#endif

#ifndef _INC_MMSYSTEM
  #include <mmsystem.h>
  #pragma comment(lib,"winmm.lib")
#endif

#include <intrin.h>

class Timer{

public:

    /* ?????????O??t???[??????? */
    Uint32 systemTime, prevTime;

    /* 1?X?e?b?v?????(msec) */
    float dt;

    /******************************************
                                Singleton???\?b?h
     ******************************************/
    /* Singleton?C???X?^???X???? */
    static Timer *getInstance();

    /* Singleton?C???X?^???X?j?? */
    static void releaseInstance();

    /***************************************************
                                                ?C???^?t?F?[?X
     ***************************************************/
    /* ??????Z?b?g????????B
         ?V?[???N???X???????[?v???????K?v?????? */
    void update(void);

    /******************************************************************
                                RDTSC??????p?????^?C?}?????????
     ******************************************************************/
    /* RDTSC?????CPU??N???b?N?J?E???^???W?X?^??l?????o?? */
    ULONGLONG getRDTSCClockCount();

    /* ?N???b?N?J?E???g??msec???????? */
    double getRDTSCMSeconds( ULONGLONG clockCount );

private:

    ULONGLONG cpuClock;			// CPU?N???b?N???g???l

    /***************************
                    Timer?C???X?^???X
     ***************************/
    static Timer *timInstance;
    static int timInitialized;		// ??????????????????????(1: ???????????????????, 0: ????????????????)

    /***************************************************
                            ?R???X?g???N?^ / ?f?X?g???N?^
     ***************************************************/
    /* ?R???X?g???N?^ */
    Timer();

    /* ?f?X?g???N?^ */
    virtual ~Timer();

    /* ?^?C?}?[???????? */
    void initializeTimer(void);

    /******************************************************************
                        RDTSC??????p?????^?C?}???????????????
     ******************************************************************/
    /* ?v???C?I???e?B??????? */
    void hiPriority( BOOL enable );

    /* CPU??????N???b?N?????(1000msec??????) */
    void calcCPUClock();

};
#endif
